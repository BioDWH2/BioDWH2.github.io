<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
  <title>BioDWH2</title>
  <style>
    .links a:link,
    .links a:visited,
    .links a:hover,
    .links a:active {
      color: #000000 !important;
      text-decoration: none;
    }
  </style>
</head>

<body style="padding-top: 55px;">
  <nav class="navbar navbar-expand-md navbar-light fixed-top bg-light">
    <div class="container-fluid">
      <img src="../assets/BioDWH2-logo.png"><span class="ms-4">Mapping-Spy</span>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarText"
        aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarText">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <li class="nav-item active">
            <a class="nav-link btn btn-outline-secondary" type="button" href="https://github.com/BioDWH2"
              target="_blank">GitHub</a>
          </li>
          <li class="nav-item active ms-1">
            <a class="nav-link btn btn-outline-secondary" type="button"
              href="https://github.com/BioDWH2/BioDWH2/blob/master/README.md" target="_blank">Documentation</a>
          </li>
          <li class="nav-item active ms-1">
            <a class="nav-link btn btn-outline-secondary" type="button" href="https://github.com/BioDWH2/BioDWH2/issues"
              target="_blank">Issues</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <main role="main">
    <div class="container-fluid my-4" style="max-width: 100%">
      <div class="row">
        <div class="col">
          <div class="input-group mx-1" style="width: 400px">
            <input type="file" class="form-control" id="mappingLogInput" aria-label="Select mapping log file">
          </div>
          <div id="mappingContent"></div>
        </div>
      </div>
    </div>
  </main>
  <footer class="container-fluid" style="max-width: 1150px;">
  <a href="https://agbi.techfak.uni-bielefeld.de" target="_blank">
      <img src="../assets/ag_bioinformatics_logo.png" style="float: right;">
  </a>
  <p class="links">
      &copy; 2022 -
      <a href="https://agbi.techfak.uni-bielefeld.de" target="_blank">Bioinformatics/Medical Informatics department</a>,
      <a href="http://techfak.de" target="_blank">Faculty of Technology</a>,
      <a href="https://www.uni-bielefeld.de" target="_blank">Bielefeld University</a>
  </p>
  <span style="clear: both;"></span>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
  crossorigin="anonymous"></script>

  <script>
  window.mappingTrees = {};

  function createTreeTableRecursive(node) {
    var text = '<table class="table table-bordered border-primary"><tbody>';
    text += '<tr>';
    if (node.children.length > 0) {
      text += '<td>';
      for (var i = 0; i < node.children.length; i++) {
        text += createTreeTableRecursive(node.children[i]);
      }
      text += '</td>';
    }
    text += '<td colspan="' + node.children.length + '">';
    if (node.__mapped == false) {
      text += '<span class="badge bg-primary">';
    } else {
      text += '<span class="badge bg-secondary">';
    }
    text += node.label;
    text += '</span>';
    text += '<br/><span class="badge bg-light text-dark">' + node.id + '</span>';
    text += '<br/><strong>IDs:</strong> ';
    var idOverlap = {};
    for (var i = 0; i < node.children.length; i++) {
      for (var j = 0; j < node.children[i].ids.length; j++) {
        var id = node.children[i].ids[j];
        if (Object.prototype.hasOwnProperty.call(idOverlap, id)) {
          idOverlap[id] += 1;
        } else {
          idOverlap[id] = 1;
        }
      }
    }
    for (var i = 0; i < node.ids.length; i++) {
      var color = idOverlap[node.ids[i]] > 1 ? 'bg-info text-dark' : 'bg-light text-dark';
      text += '<span class="badge rounded-pill ' + color + ' id-pill" style="border-style: solid; border-color: black; border-width: 0px">' + node.ids[i] + '</span>';
    }
    text += '<br/><strong>Names:</strong> ';
    for (var i = 0; i < node.names.length; i++) {
      text += '<span class="badge rounded-pill bg-light text-dark">' + node.names[i] + '</span>';
    }
    text += '</td>';
    text += '</tr></tbody></table>';
    return text;
  }

  window.addEventListener('load', function() {
    var mappingContent = document.getElementById('mappingContent');
    var input = document.getElementById('mappingLogInput');
    input.addEventListener('change', function() {
      var file = this.files[0];
      var reader = new FileReader();
      reader.onload = function(progressEvent) {
        var lines = this.result.split('\n');
        for(var line = 0; line < lines.length; line++) {
          var tree = JSON.parse(lines[line]);
          // Ignore singleton mapped nodes (just one source node connected to a mapped node)
          if (tree.children.length > 2) {
            window.mappingTrees[tree.id] = tree;
          }
        }
        mappingContent.innerHTML = '<div class="alert alert-success" role="alert">' +
          'Loaded ' + Object.keys(window.mappingTrees).length + ' mapping clusters' +
          '</div>' + createTreeTableRecursive(window.mappingTrees[484125924681442]);
        var idPills = document.getElementsByClassName('id-pill');
        for (var i = 0; i < idPills.length; i++) {
          idPills[i].addEventListener('click', (e) => {
            for (var j = 0; j < idPills.length; j++) {
              if (idPills[j].innerText === e.target.innerText){
                idPills[j].style.borderWidth = idPills[j].style.borderWidth == '0px' ? '1px' : '0px';
              }
            }
          });
        }
      };
      reader.readAsText(file);
    });
  }, false);
  </script>
</body>

</html>
